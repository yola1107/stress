version: "3.8"

networks:
  rabbitmq-net:
    driver: bridge

services:
  rabbitmq1:
    image: rabbitmq:4.2.1-management
    container_name: rabbitmq1
    hostname: rabbitmq1
    environment:
      RABBITMQ_NODENAME: rabbit@rabbitmq1
      RABBITMQ_ERLANG_COOKIE: "RABBITMQ_CLUSTER_COOKIE"
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      # Erlang VM 高并发优化（内存水位线在 rabbitmq.conf 中配置）
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "+P 1048576 +Q 65536"
    volumes:
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./rabbitmq/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie
      - ./data/rabbitmq1:/var/lib/rabbitmq
    ports:
      - "15672:15672"   # 管理界面端口
      - "15692:15692"   # Prometheus 指标端口 (rabbitmq_prometheus)
    sysctls:
      - net.core.somaxconn=65535
    ulimits:
      nofile:
        soft: 1024000
        hard: 1024000
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - rabbitmq-net

  rabbitmq2:
    image: rabbitmq:4.2.1-management
    container_name: rabbitmq2
    hostname: rabbitmq2
    ports:
      - "15693:15692"   # Prometheus 指标端口
    environment:
      RABBITMQ_NODENAME: rabbit@rabbitmq2
      RABBITMQ_ERLANG_COOKIE: "RABBITMQ_CLUSTER_COOKIE"
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      # Erlang VM 高并发优化（内存水位线在 rabbitmq.conf 中配置）
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "+P 1048576 +Q 65536"
    volumes:
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./rabbitmq/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie
      - ./data/rabbitmq2:/var/lib/rabbitmq
    sysctls:
      - net.core.somaxconn=65535
    ulimits:
      nofile:
        soft: 1024000
        hard: 1024000
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - rabbitmq-net

  rabbitmq3:
    image: rabbitmq:4.2.1-management
    container_name: rabbitmq3
    hostname: rabbitmq3
    ports:
      - "15694:15692"   # Prometheus 指标端口
    environment:
      RABBITMQ_NODENAME: rabbit@rabbitmq3
      RABBITMQ_ERLANG_COOKIE: "RABBITMQ_CLUSTER_COOKIE"
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin
      # Erlang VM 高并发优化（内存水位线在 rabbitmq.conf 中配置）
      RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS: "+P 1048576 +Q 65536"
    volumes:
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
      - ./rabbitmq/.erlang.cookie:/var/lib/rabbitmq/.erlang.cookie
      - ./data/rabbitmq3:/var/lib/rabbitmq
    sysctls:
      - net.core.somaxconn=65535
    ulimits:
      nofile:
        soft: 1024000
        hard: 1024000
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    networks:
      - rabbitmq-net

  haproxy:
    image: haproxy:2.8
    container_name: rabbitmq-haproxy
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "5672:5672"   # AMQP对外端口
    sysctls:
      - net.core.somaxconn=65535
    ulimits:
      nofile:
        soft: 1024000
        hard: 1024000
    depends_on:
      rabbitmq1:
        condition: service_healthy
      rabbitmq2:
        condition: service_healthy
      rabbitmq3:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - rabbitmq-net
